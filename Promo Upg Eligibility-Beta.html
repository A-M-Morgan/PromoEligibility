<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Promo Upgrade Eligibility Checker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{ --brand-blue:#0b57d0; --brand-blue-100:#e6f0ff; --brand-violet:#6b21a8; --brand-violet-100:#f1e6ff; --accent:#0aa370; --accent-100:#e7f7ef; --danger:#b8143a; --danger-100:#ffe8ed; --card:#ffffff; --bg:linear-gradient(135deg,#f3f6ff 0%,#fff 40%,#fff4ff 100%); --attention:#d90429; --border:#dae0e7; }
    *{box-sizing:border-box}
    body{font-family:Segoe UI, Roboto, Arial, sans-serif;margin:0;color:#1e1f20;background:var(--bg);} 
    header{padding:28px 24px;background:linear-gradient(135deg,#0058b0 0%,#7a3ac3 100%);color:#fff}
    h1{margin:0 0 6px 0;font-size:1.6rem}.subtitle{opacity:.9;font-size:.95rem}
    main{padding:24px}.wrap{max-width:1100px;margin:0 auto}
    .card{background:var(--card);box-shadow:0 6px 20px rgba(0,0,0,.06);border-radius:12px;padding:16px;margin-bottom:24px;border:1px solid rgba(0,0,0,.06)}

    /* Alignment grids */
    .grid-top{display:grid;grid-template-columns:1.2fr 1.1fr 0.9fr 0.9fr;gap:16px;align-items:start}
    .grid-logic{display:grid;grid-template-columns:repeat(2,1fr);gap:16px;align-items:start}

    .field{display:flex;flex-direction:column;gap:8px}
    .label-wrap{min-height:42px;display:flex;align-items:flex-end;font-weight:700}
    .badge-and-label{display:flex;align-items:center;gap:10px;min-height:42px}

    label{font-weight:700}
    input[type="text"],input[type="datetime-local"],select{width:100%;padding:12px;border:1px solid #ccd3db;border-radius:10px;background:#fff}
    select{appearance:none;background-image:url('data:image/svg+xml;utf8,<svg fill="%23666" height="20" viewBox="0 0 20 20" width="20" xmlns="http://www.w3.org/2000/svg"><polygon points="5,7 10,12 15,7"/></svg>');background-repeat:no-repeat;background-position:right 10px center;background-size:16px}

    .icon-only::-webkit-datetime-edit{color:transparent}.icon-only:focus::-webkit-datetime-edit{color:inherit}
    .icon-only::-webkit-calendar-picker-indicator{opacity:1}.icon-only{color:transparent}.icon-only:focus{color:inherit}

    .actions{display:flex;flex-wrap:wrap;gap:12px;margin-top:8px}
    button{padding:10px 16px;border:none;border-radius:10px;cursor:pointer;font-weight:700}
    button.primary{background:#0b57d0;color:#fff} button.secondary{background:#f1f3f9;color:#111}
    button.attention{background:var(--attention);color:#fff;animation:pulse 1s infinite}
    @keyframes pulse{0%,100%{opacity:1} 50%{opacity:.55} }

    .result{padding:16px;border-radius:12px;font-weight:700;border:1px solid}
    .offer{background:var(--accent-100);color:#0a5d3a;border-color:#9be2a0}
    .no-offer{background:var(--danger-100);color:var(--danger);border-color:#f0b3b3}
    .result .fallback{margin-top:10px;font-weight:600}

    .note{font-size:.92em;color:#555}.footer{display:none}.clock{font-weight:700}
    optgroup{font-style:normal;font-weight:600}

    .select-colored{transition:background-color .2s,color .2s,border-color .2s}
    .select-yes{background:var(--brand-blue-100);color:var(--brand-blue);border-color:#99b7ff}
    .select-no{background:var(--brand-violet-100);color:var(--brand-violet);border-color:#c9a7ff}
    .disabled-select{opacity:.5;pointer-events:none}
    .step-badge{display:inline-block;background:#f1f3f9;color:#333;border:1px solid var(--border);border-radius:8px;padding:4px 8px;font-weight:700;font-size:.85rem;white-space:nowrap}

    .muted{color:#444;font-size:.95rem}
    .top-inline-help{margin-top:6px}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>Promo Upgrade Eligibility Checker</h1>
      <div class="subtitle">Time window → document type → RBD → ticket type → previous PROMO status → N/P/Z class → PROMO UPGRADE</div>
    </div>
  </header>
  <main>
    <div class="wrap">
      <div class="card">
        <h2 style="margin:0 0 8px 0;">Instructions</h2>
        <ol class="muted" style="margin:0; padding-left:18px;">
          <li>Select <strong>City of departure (for local time)</strong> + <strong>Scheduled departure Date &amp; Time</strong></li>
          <li>Click on <em><strong>Auto-Cal travel window</strong></em> to calculate eligibility.</li>
          <li><strong>Reset</strong> after every query or result.</li>
        </ol>
      </div>

      <div class="card">
        <!-- TOP GRID -->
        <div class="grid-top">
          <!-- City of departure -->
          <div class="field">
            <div class="label-wrap"><label for="citySelect">City of departure</label></div>
            <select id="citySelect">
              <option value="">— Use my system time —</option>
              <optgroup label="India">
                <option value="Asia/Kolkata" data-name="Ahmedabad">Ahmedabad</option>
                <option value="Asia/Kolkata" data-name="Bengaluru">Bengaluru</option>
                <option value="Asia/Kolkata" data-name="Chennai">Chennai</option>
                <option value="Asia/Kolkata" data-name="Delhi">Delhi</option>
                <option value="Asia/Kolkata" data-name="Hyderabad">Hyderabad</option>
                <option value="Asia/Kolkata" data-name="Kochi">Kochi</option>
                <option value="Asia/Kolkata" data-name="Kolkata">Kolkata</option>
                <option value="Asia/Kolkata" data-name="Mumbai">Mumbai</option>
                <option value="Asia/Kolkata" data-name="Thiruvananthapuram">Thiruvananthapuram</option>
              </optgroup>
              <optgroup label="Middle East">
                <option value="Asia/Dubai" data-name="Dubai">Dubai</option>
                <option value="Asia/Doha" data-name="Doha">Doha</option>
                <option value="Asia/Riyadh" data-name="Riyadh">Riyadh</option>
                <option value="Asia/Riyadh" data-name="Jeddah">Jeddah</option>
                <option value="Asia/Riyadh" data-name="Dammam">Dammam</option>
                <option value="Asia/Riyadh" data-name="Dhahran">Dhahran</option>
                <option value="Asia/Kuwait" data-name="Kuwait City">Kuwait City</option>
                <option value="Asia/Baghdad" data-name="Baghdad">Baghdad</option>
                <option value="Asia/Tehran" data-name="Tehran">Tehran</option>
                <option value="Asia/Tehran" data-name="Mashhad">Mashhad</option>
                <option value="Asia/Jerusalem" data-name="Tel Aviv">Tel Aviv</option>
                <option value="Asia/Beirut" data-name="Beirut">Beirut</option>
                <option value="Asia/Amman" data-name="Amman">Amman</option>
                <option value="Asia/Muscat" data-name="Muscat">Muscat</option>
                <option value="Asia/Bahrain" data-name="Manama">Manama</option>
              </optgroup>
              <optgroup label="Africa">
                <option value="Africa/Cairo" data-name="Cairo">Cairo</option>
                <option value="Africa/Casablanca" data-name="Casablanca">Casablanca</option>
                <option value="Africa/Accra" data-name="Accra">Accra</option>
                <option value="Africa/Addis_Ababa" data-name="Addis Ababa">Addis Ababa</option>
                <option value="Indian/Mauritius" data-name="Port Louis">Port Louis</option>
                <option value="Africa/Nairobi" data-name="Nairobi">Nairobi</option>
                <option value="Africa/Johannesburg" data-name="Johannesburg">Johannesburg</option>
                <option value="Africa/Johannesburg" data-name="Durban">Durban</option>
                <option value="Africa/Johannesburg" data-name="Cape Town">Cape Town</option>
                <option value="Africa/Algiers" data-name="Algiers">Algiers</option>
                <option value="Africa/Luanda" data-name="Luanda">Luanda</option>
                <option value="Africa/Abidjan" data-name="Abidjan">Abidjan</option>
                <option value="Africa/Lusaka" data-name="Lusaka">Lusaka</option>
                <option value="Africa/Harare" data-name="Harare">Harare</option>
                <option value="Africa/Conakry" data-name="Conakry">Conakry</option>
                <option value="Africa/Dakar" data-name="Dakar">Dakar</option>
                <option value="Africa/Khartoum" data-name="Khartoum">Khartoum</option>
                <option value="Africa/Addis_Ababa" data-name="Seychelles">Seychelles</option>
                <option value="Africa/Tunis" data-name="Tunis">Tunis</option>
                <option value="Africa/Abuja" data-name="Abuja">Abuja</option>
                <option value="Africa/Lagos" data-name="Lagos">Lagos</option>
                <option value="Africa/Addis_Ababa" data-name="Entebbe">Entebbe</option>
                <option value="Africa/Nairobi" data-name="Dar es Salaam">Dar es Salaam</option>
                <option value="Indian/Antananarivo" data-name="Antananarivo">Antananarivo</option>
                <option value="Africa/Cairo" data-name="Alexandria">Alexandria</option>
              </optgroup>
              <optgroup label="Europe">
                <option value="Europe/Amsterdam" data-name="Amsterdam">Amsterdam</option>
                <option value="Europe/Athens" data-name="Athens">Athens</option>
                <option value="Europe/Amsterdam" data-name="Brussels">Brussels</option>
                <option value="Europe/London" data-name="Birmingham">Birmingham</option>
                <option value="Europe/Budapest" data-name="Budapest">Budapest</option>
                <option value="Europe/Copenhagen" data-name="Copenhagen">Copenhagen</option>
                <option value="Europe/Berlin" data-name="Düsseldorf">Düsseldorf</option>
                <option value="Europe/London" data-name="Edinburgh">Edinburgh</option>
                <option value="Europe/Berlin" data-name="Frankfurt">Frankfurt</option>
                <option value="Europe/Zurich" data-name="Geneva">Geneva</option>
                <option value="Europe/London" data-name="Glasgow">Glasgow</option>
                <option value="Europe/Hamburg" data-name="Hamburg">Hamburg</option>
                <option value="Europe/Lisbon" data-name="Lisbon">Lisbon</option>
                <option value="Europe/London" data-name="London">London</option>
                <option value="Europe/Madrid" data-name="Madrid">Madrid</option>
                <option value="Europe/London" data-name="Manchester">Manchester</option>
                <option value="Europe/Rome" data-name="Milan">Milan</option>
                <option value="Europe/Munich" data-name="Munich">Munich</option>
                <option value="Europe/Paris" data-name="Nice">Nice</option>
                <option value="Europe/Oslo" data-name="Oslo">Oslo</option>
                <option value="Europe/Paris" data-name="Paris">Paris</option>
                <option value="Europe/Prague" data-name="Prague">Prague</option>
                <option value="Europe/Rome" data-name="Rome">Rome</option>
                <option value="Europe/Stockholm" data-name="Stockholm">Stockholm</option>
                <option value="Europe/Zurich" data-name="Zurich">Zurich</option>
                <option value="Europe/Vienna" data-name="Vienna">Vienna</option>
                <option value="Europe/Venice" data-name="Venice">Venice</option>
              </optgroup>
              <optgroup label="Asia">
                <option value="Asia/Shanghai" data-name="Beijing">Beijing</option>
                <option value="Asia/Bangkok" data-name="Bangkok">Bangkok</option>
                <option value="Asia/Baghdad" data-name="Basra">Basra</option>
                <option value="Asia/Colombo" data-name="Colombo">Colombo</option>
                <option value="Asia/Makassar" data-name="Denpasar">Denpasar</option>
                <option value="Asia/Baghdad" data-name="Erbil">Erbil</option>
                <option value="Asia/Shanghai" data-name="Guangzhou">Guangzhou</option>
                <option value="Asia/Shanghai" data-name="Hangzhou">Hangzhou</option>
                <option value="Asia/Hong_Kong" data-name="Hong Kong">Hong Kong</option>
                <option value="Asia/Ho_Chi_Minh" data-name="Hanoi">Hanoi</option>
                <option value="Asia/Ho_Chi_Minh" data-name="Ho Chi Minh City">Ho Chi Minh City</option>
                <option value="Asia/Jakarta" data-name="Jakarta">Jakarta</option>
                <option value="Asia/Karachi" data-name="Islamabad">Islamabad</option>
                <option value="Asia/Karachi" data-name="Karachi">Karachi</option>
                <option value="Asia/Kolkata" data-name="Kolkata">Kolkata</option>
                <option value="Asia/Kuala_Lumpur" data-name="Kuala Lumpur">Kuala Lumpur</option>
                <option value="Asia/Tokyo" data-name="Nagoya">Nagoya</option>
                <option value="Asia/Tokyo" data-name="Osaka">Osaka</option>
                <option value="Asia/Taipei" data-name="Taipei">Taipei</option>
                <option value="Asia/Tokyo" data-name="Tokyo">Tokyo</option>
                <option value="Asia/Shanghai" data-name="Shanghai">Shanghai</option>
                <option value="Asia/Shanghai" data-name="Shenzhen">Shenzhen</option>
                <option value="Asia/Shanghai" data-name="Guangzhou">Guangzhou</option>
                <option value="Asia/Singapore" data-name="Singapore">Singapore</option>
                <option value="Asia/Yangon" data-name="Yangon">Yangon</option>
                <option value="Asia/Tbilisi" data-name="Tbilisi">Tbilisi</option>
		<option value="Asia/Dhaka" data-name="Dhaka">Dhaka</option>
              </optgroup>
              <optgroup label="Oceania">
                <option value="Australia/Adelaide" data-name="Adelaide">Adelaide</option>
                <option value="Australia/Brisbane" data-name="Brisbane">Brisbane</option>
                <option value="Pacific/Auckland" data-name="Auckland">Auckland</option>
                <option value="Pacific/Auckland" data-name="Christchurch">Christchurch</option>
                <option value="Australia/Melbourne" data-name="Melbourne">Melbourne</option>
                <option value="Australia/Perth" data-name="Perth">Perth</option>
                <option value="Australia/Sydney" data-name="Sydney">Sydney</option>
              </optgroup>
              <optgroup label="Americas">
                <option value="America/Buenos_Aires" data-name="Buenos Aires">Buenos Aires</option>
                <option value="America/Chicago" data-name="Chicago">Chicago</option>
                <option value="America/Dallas" data-name="Dallas">Dallas</option>
                <option value="America/Houston" data-name="Houston">Houston</option>
                <option value="America/Los_Angeles" data-name="Las Vegas">Las Vegas</option>
                <option value="America/Los_Angeles" data-name="Los Angeles">Los Angeles</option>
                <option value="America/Miami" data-name="Miami">Miami</option>
                <option value="America/New_York" data-name="Boston">Boston</option>
                <option value="America/New_York" data-name="Fort Lauderdale">Fort Lauderdale</option>
                <option value="America/New_York" data-name="New York City">New York City</option>
                <option value="America/New_York" data-name="Newark">Newark</option>
                <option value="America/New_York" data-name="Orlando">Orlando</option>
                <option value="America/New_York" data-name="Washington, D.C.">Washington, D.C.</option>
                <option value="America/Los_Angeles" data-name="San Francisco">San Francisco</option>
                <option value="America/Los_Angeles" data-name="Seattle">Seattle</option>
                <option value="America/Santiago" data-name="Santiago">Santiago</option>
                <option value="America/Sao_Paulo" data-name="Rio de Janeiro">Rio de Janeiro</option>
                <option value="America/Sao_Paulo" data-name="São Paulo">São Paulo</option>
                <option value="America/Toronto" data-name="Montreal">Montreal</option>
                <option value="America/Toronto" data-name="Toronto">Toronto</option>
              </optgroup>
            </select>
            <div class="top-inline-help note">Local time: <span class="clock" id="cityClock"></span></div>
          </div>

          <!-- Type & search (Type the city name) -->
          <div class="field">
            <div class="label-wrap"><label for="citySearch">Type &amp; search</label> <span class="note" style="margin-left:6px;">(Type the city name)</span></div>
            <input type="text" id="citySearch" placeholder="Type city name (e.g., Mumbai, Stockholm)" list="cityNameList" />
            <datalist id="cityNameList"></datalist>
          </div>

          <!-- Departure -->
          <div class="field">
            <div class="label-wrap"><label for="departure">Select departure date &amp; time → <strong>Auto‑Cal</strong></label></div>
            <input type="datetime-local" id="departure" class="icon-only" />
            <div class="actions"><button class="attention" id="autoCalcBtn">Auto-Cal travel window</button></div>
          </div>

          <!-- STEP 1 -->
          <div class="field">
            <div class="badge-and-label"><span class="step-badge">STEP 1</span><label for="travelWindow">Travel between 72 hrs and 6 hrs</label></div>
            <select id="travelWindow" class="select-colored disabled-select" disabled>
              <option value="">— Auto —</option>
              <option value="YES">YES</option>
              <option value="NO">NO</option>
            </select>
          </div>
        </div>

        <!-- LOGIC GRID -->
        <div class="grid-logic" style="margin-top:16px;">
          <div class="field">
            <div class="badge-and-label"><span class="step-badge">STEP 2</span><label for="documentType">Select document type</label></div>
            <select id="documentType" class="select-colored">
              <option value="">— Select —</option>
              <option value="176">176</option>
              <option value="OAL">OAL DOCUMENT</option>
            </select>
          </div>
          <div class="field">
            <div class="badge-and-label"><span class="step-badge">STEP 3</span><label for="rbdSelection">Select the ticketed RBD for the flight that's being upgraded</label></div>
            <select id="rbdSelection" class="select-colored">
              <option value="">— Select —</option>
              <option value="SVGNDPH">S, V, G, N, D, P, H</option>
              <option value="OTHER">All Other RBDs</option>
            </select>
          </div>
          <div class="field">
            <div class="badge-and-label"><span class="step-badge">STEP 4</span><label for="ticketType">Select the type of ticket</label></div>
            <select id="ticketType" class="select-colored">
              <option value="">— Select —</option>
              <option value="REVENUE">REVENUE/CPM (GDS-EK Direct Channel)</option>
              <option value="OTHER">All other tickets</option>
            </select>
          </div>
          <div class="field">
            <div class="badge-and-label"><span class="step-badge">STEP 5</span><label for="prevPromoStatus">Previous PROMO UPG status on the ticket</label></div>
            <select id="prevPromoStatus" class="select-colored">
              <option value="">— Select —</option>
              <option value="AVAILED">Availed</option>
              <option value="NOT_AVAILED">Not Availed</option>
            </select>
          </div>
          <div class="field">
            <div class="badge-and-label"><span class="step-badge">STEP 6</span><label for="classAvailability">Check <em>N/P/Z</em> class availability in ResConnect for the specific sector</label></div>
            <select id="classAvailability" class="select-colored">
              <option value="">— Select —</option>
              <option value="AVAILABLE">Available</option>
              <option value="NOT_AVAILABLE">Not Available</option>
            </select>
          </div>
        </div>

        <div class="actions">
          <button class="primary" id="evaluateBtn">Evaluate</button>
          <button class="secondary" id="resetBtn">Reset</button>
          <button class="secondary" id="downloadBtn" disabled>Download Decision</button>
        </div>
      </div>

      <div id="resultContainer"></div>
      <div class="footer"></div>
    </div>
  </main>

  <script>
    // Sort cities alphabetically within each optgroup by visible name
    (function sortCityGroups(){ const sel=document.getElementById('citySelect'); sel.querySelectorAll('optgroup').forEach(group=>{ const opts=Array.from(group.querySelectorAll('option')); opts.sort((a,b)=> a.getAttribute('data-name').localeCompare(b.getAttribute('data-name'))); opts.forEach(o=> group.appendChild(o)); }); })();

    // Build cityMap (name->tz) and datalist
    const cityMap = {}; const cityNames = [];
    document.querySelectorAll('#citySelect option[data-name]').forEach(opt=>{ const name=opt.getAttribute('data-name'); cityMap[name]=opt.value; cityNames.push(name); });
    cityNames.sort();
    const cityNameListEl = document.getElementById('cityNameList');
    cityNames.forEach(n=>{ const o=document.createElement('option'); o.value=n; cityNameListEl.appendChild(o); });

    let selectedTZ = Intl.DateTimeFormat().resolvedOptions().timeZone;
    const citySelectEl = document.getElementById('citySelect');
    const citySearchEl = document.getElementById('citySearch');
    const cityClockEl = document.getElementById('cityClock');

    function updateClock(){ const tz = selectedTZ || Intl.DateTimeFormat().resolvedOptions().timeZone; const now=new Date(); cityClockEl.textContent= now.toLocaleString(undefined,{timeZone:tz,hour12:false}); }
    updateClock(); setInterval(updateClock,1000);

    // Fuzzy helpers
    function levenshtein(a,b){ a=a.toLowerCase(); b=b.toLowerCase(); const m=Array(a.length+1).fill(0).map(()=>Array(b.length+1).fill(0)); for(let i=0;i<=a.length;i++) m[i][0]=i; for(let j=0;j<=b.length;j++) m[0][j]=j; for(let i=1;i<=a.length;i++){ for(let j=1;j<=b.length;j++){ const cost=a[i-1]===b[j-1]?0:1; m[i][j]=Math.min(m[i-1][j]+1,m[i][j-1]+1,m[i-1][j-1]+cost); } } return m[a.length][b.length]; }
    function bestCity(input){ const q=(input||'').trim(); if(!q) return null; const exact=cityNames.find(n=>n.toLowerCase()===q.toLowerCase()); if(exact) return exact; const pref=cityNames.filter(n=>n.toLowerCase().startsWith(q.toLowerCase())); if(pref.length===1) return pref[0]; if(pref.length>1) return pref.sort()[0]; let best=null,dist=99; for(const n of cityNames){ const d=levenshtein(q,n); if(d<dist){dist=d;best=n;} } const th=q.length<=4?1:2; return dist<=th?best:null; }

    // Select dropdown by exact city name (index-based to avoid tz collisions)
    function selectDropdownByCityName(name){ let index=-1; const opts=citySelectEl.querySelectorAll('option'); opts.forEach((opt,i)=>{ if(opt.getAttribute('data-name')===name){ index=i; } }); if(index>=0){ citySelectEl.selectedIndex=index; selectedTZ = cityMap[name]; updateClock(); } }

    // Syncs
    citySearchEl.addEventListener('input', ()=>{ const chosen=bestCity(citySearchEl.value); if(!chosen) return; selectDropdownByCityName(chosen); });
    citySelectEl.addEventListener('change', ()=>{ selectedTZ = citySelectEl.value || Intl.DateTimeFormat().resolvedOptions().timeZone; const name = citySelectEl.selectedOptions[0]?.getAttribute('data-name'); if(name) citySearchEl.value = name; updateClock(); });

    // --- Time calculations ---
    function getTimeZoneOffset(date, timeZone){ const dtf=new Intl.DateTimeFormat('en-US',{timeZone,hour12:false,year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit',second:'2-digit'}); const parts=dtf.formatToParts(date).reduce((a,p)=>{a[p.type]=p.value;return a;},{}); const asUTC=Date.UTC(parts.year,Number(parts.month)-1,parts.day,parts.hour,parts.minute,parts.second); return (asUTC-date.getTime())/60000; }
    function tzLocalPartsToUTC(y,m,d,h,mi,tz){ const approx=Date.UTC(y,m-1,d,h,mi); const off=getTimeZoneOffset(new Date(approx),tz); return approx-off*60000; }
    function parseDatetimeLocal(v){ const [d,t]=v.split('T'); const [y,m,da]=d.split('-').map(Number); const [h,mi]=t.split(':').map(Number); return {y,m,da,h,mi}; }

    const fields=["travelWindow","documentType","rbdSelection","ticketType","prevPromoStatus","classAvailability"];
    const stepIndexMap={travelWindow:1,documentType:2,rbdSelection:3,ticketType:4,prevPromoStatus:5,classAvailability:6};

    // Auto-Cal
    document.getElementById('autoCalcBtn').addEventListener('click', ()=>{
      const input=document.getElementById('departure').value; if(!input){ alert('Please enter a scheduled departure date/time.'); return; }
      const tz=selectedTZ || Intl.DateTimeFormat().resolvedOptions().timeZone; const p=parseDatetimeLocal(input); const depUTC=tzLocalPartsToUTC(p.y,p.m,p.da,p.h,p.mi,tz); const nowUTC=Date.now(); const diffHrs=(depUTC-nowUTC)/(1000*60*60); const within= diffHrs>=6 && diffHrs<=72; const sel=document.getElementById('travelWindow'); sel.value = within ? 'YES':'NO'; sel.classList.remove('select-yes','select-no'); sel.classList.add(within? 'select-yes':'select-no'); autoEvaluate();
    });

    function colorizeSelect(sel){ sel.classList.remove('select-yes','select-no'); const pos=new Set(['YES','REVENUE','NOT_AVAILED','AVAILABLE','176','OTHER']); sel.classList.add(pos.has(sel.value)?'select-yes':'select-no'); }
    document.querySelectorAll('.select-colored').forEach(sel=> sel.addEventListener('change', ()=>{ colorizeSelect(sel); autoEvaluate(); }));

    document.getElementById('evaluateBtn').addEventListener('click', evaluate);
    function evaluate(){ const decision=computeDecision(true); if(!decision) return; renderResult(decision); }
    function autoEvaluate(){ const decision=computeDecision(false); if(decision && decision.final){ renderResult(decision); enableDownload(decision); } }

    function computeDecision(strict){
      const v=Object.fromEntries(fields.map(id=>[id, document.getElementById(id).value]));
      const reasons=[]; let final=""; let failedStep=0;
      if(v.travelWindow==='NO'){ final='DO NOT PROCESS: Travel not between 72 hrs and 6 hrs.'; reasons.push('Travel not between 72 hrs and 6 hrs.'); failedStep=1; return {final,reasons,failedStep,cause:'travelWindow'}; }
      if(v.travelWindow!=='YES'){ if(strict){ alert('Please click Auto-Cal travel window to compute Step 1.'); } return null; }
      if(v.documentType==='OAL'){ final='DO NOT PROCESS INELIGIBLE TICKET DOCUMENT'; reasons.push('Document type is OAL DOCUMENT.'); failedStep=2; return {final,reasons,failedStep,cause:'documentType'}; }
      if(v.documentType!=='176'){ if(strict){ alert('Please select an answer for: Select document type'); } return null; }
      if(v.rbdSelection==='SVGNDPH'){ final='DO NOT PROCESS INELIGIBLE RBD'; reasons.push('Ticketed RBD is S/V/G/N/D/P/H.'); failedStep=3; return {final,reasons,failedStep,cause:'rbdSelection'}; }
      if(v.rbdSelection!=='OTHER'){ if(strict){ alert('Please select an answer for: Ticketed RBD selection'); } return null; }
      if(v.ticketType==='OTHER'){ final='DO NOT PROCESS INELIGIBLE TICKET'; reasons.push('Ticket type is not REVENUE (GDS-EK Direct Channel).'); failedStep=4; return {final,reasons,failedStep,cause:'ticketType'}; }
      if(v.ticketType!=='REVENUE'){ if(strict){ alert('Please select an answer for: Type of ticket'); } return null; }
      if(v.prevPromoStatus==='AVAILED'){ final='DO NOT PROCESS INELIGIBLE TICKET'; reasons.push('Previous PROMO UPG already availed on the same ticket.'); failedStep=5; return {final,reasons,failedStep,cause:'prevPromoStatus'}; }
      if(v.prevPromoStatus!=='NOT_AVAILED'){ if(strict){ alert('Please select an answer for: Previous PROMO UPG status'); } return null; }
      if(v.classAvailability==='NOT_AVAILABLE'){ final='DO NOT PROCESS PROMO UPG NOT AVAILABLE'; reasons.push('N/P/Z class is not available in ResConnect for the sector.'); failedStep=6; return {final,reasons,failedStep,cause:'classAvailability'}; }
      if(v.classAvailability!=='AVAILABLE'){ if(strict){ alert('Please select an answer for: N/P/Z class availability'); } return null; }
      final='STEP 7: Proceed with Promo Upgrade Auto Flow on ResConnect'; return {final,reasons,failedStep:0};
    }

    function renderResult(payload){ const {final,reasons,failedStep,cause}=payload; const container=document.getElementById('resultContainer'); container.innerHTML=''; const div=document.createElement('div'); const isOffer=final.startsWith('STEP 7'); const isDoNot=final.startsWith('DO NOT'); div.className='result '+(isOffer? 'offer':'no-offer'); const showVerbiage=isDoNot && cause!=='documentType'; div.innerHTML=`<div><strong>Result:</strong> ${final}</div>${reasons.length? `<div style="margin-top:8px;"><strong>Reason(s):</strong> ${reasons.join('; ')}</div>`:''}${showVerbiage? `<div class=\"fallback\">Thank you for your interest in the Promotional Upgrade. Our promotional upgrade offer is not available on this flight. I do have seats available at our regular pricing. And this would include the benefits such as chauffeur and lounge as well earning Skywards Miles - Let me tell you the price of this fare.</div>`:''}`; container.appendChild(div); if(isDoNot){ disableFollowing(failedStep); } else { enableAllLogic(); } enableDownload(payload); }

    function disableFollowing(failedStep){ Object.entries(stepIndexMap).forEach(([id,step])=>{ const el=document.getElementById(id); if(step>failedStep){ el.disabled=true; el.classList.add('disabled-select'); } else { el.disabled=false; el.classList.remove('disabled-select'); } }); }

    function enableAllLogic(){ document.querySelectorAll('select').forEach(sel=>{ sel.disabled=false; sel.classList.remove('disabled-select','select-yes','select-no'); if(sel.id && sel.id!=='travelWindow') sel.value=''; }); const tw=document.getElementById('travelWindow'); tw.disabled=true; tw.value=''; tw.classList.add('disabled-select'); tw.classList.remove('select-yes','select-no'); }

    function enableDownload(payload){ const btn=document.getElementById('downloadBtn'); btn.disabled=false; btn.onclick=()=>downloadDecision(payload); }

    function downloadDecision({final,reasons,cause}){ const now=new Date(); const name=`promo-upgrade-decision-${now.toISOString().replace(/[:.]/g,'-')}.txt`; const lines=['PROMO UPGRADE DECISION','-----------------------',`Result: ${final}`,'','Reason(s):',...(reasons.length? reasons.map(r=>' - '+r):[' - None (eligible to proceed)']),'','Message:',...((final.startsWith('DO NOT') && cause!=='documentType')? ['Thank you for your interest in the Promotional Upgrade. Our promotional upgrade offer is not available on this flight. I do have seats available at our regular pricing. And this would include the benefits such as chauffeur and lounge as well earning Skywards Miles - Let me tell you the price of this fare.'] : []),'',`Generated at: ${now.toString()}`]; const blob=new Blob([lines.join('\n')],{type:'text/plain'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=name; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); }

    // Reset: fully restore UI
    function reset(){ document.getElementById('departure').value=''; document.getElementById('citySearch').value=''; document.getElementById('citySelect').value=''; document.querySelectorAll('select').forEach(sel=>{ sel.disabled=false; sel.classList.remove('disabled-select','select-yes','select-no'); if(sel.id && sel.id!=='travelWindow') sel.value=''; }); const tw=document.getElementById('travelWindow'); tw.disabled=true; tw.value=''; tw.classList.add('disabled-select'); tw.classList.remove('select-yes','select-no'); document.getElementById('resultContainer').innerHTML=''; document.getElementById('downloadBtn').disabled=true; selectedTZ = Intl.DateTimeFormat().resolvedOptions().timeZone; updateClock(); }

    document.getElementById('resetBtn').addEventListener('click', reset);
  </script>
</body>
</html>
